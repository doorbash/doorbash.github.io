<!DOCTYPE html>
<html>

  <head>
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1">

<title>استفاده همزمان از دو مودم اینترنت - بلاگ - میلاد دورباش</title>
<meta name="description" content="من دو تا مودم اینترنت دارم. ADSL و TD-LTE. در این پست میخام بگم برای اینکه بتونم همزمان از هردوشون برای اتصال به اینترنت استفاده کنم چه کاری انجام دادم.
نسخه کوتاه: با استفاده از iptables و route در لینوکس
اولین کاری که کردم روی کامپیوتر خونه Ubuntu 20.10 نصب کردم. و وارد پنل کانفیگ یکی از مودم ها شدم و آدرس شبکه اش رو از 192.168.1.1 به 192.168.48.1 تغییر دادم تا با هم تداخل پیدا نکنند."/>
<meta name="robots" content="noodp"/>
<link rel="canonical" href="https://doorbash.github.io/blog/posts/%D8%A7%D8%B3%D8%AA%D9%81%D8%A7%D8%AF%D9%87_%D9%87%D9%85%D8%B2%D9%85%D8%A7%D9%86_%D8%A7%D8%B2_%D8%AF%D9%88_%D9%85%D9%88%D8%AF%D9%85_%D8%A7%DB%8C%D9%86%D8%AA%D8%B1%D9%86%D8%AA/" />


<meta name="twitter:card" content="summary" />
<meta name="twitter:description" content="من دو تا مودم اینترنت دارم. ADSL و TD-LTE. در این پست میخام بگم برای اینکه بتونم همزمان از هردوشون برای اتصال به اینترنت استفاده کنم چه کاری انجام دادم.
نسخه کوتاه: با استفاده از iptables و route در لینوکس
اولین کاری که کردم روی کامپیوتر خونه Ubuntu 20.10 نصب کردم. و وارد پنل کانفیگ یکی از مودم ها شدم و آدرس شبکه اش رو از 192.168.1.1 به 192.168.48.1 تغییر دادم تا با هم تداخل پیدا نکنند." />
<meta name="twitter:title" content="استفاده همزمان از دو مودم اینترنت - بلاگ - میلاد دورباش" />
<meta name="twitter:site" content="http://twitter.com/bul_ikana" />
<meta name="twitter:creator" content="http://twitter.com/bul_ikana" />


<meta property="og:type" content="article" />
<meta content="استفاده همزمان از دو مودم اینترنت - بلاگ - میلاد دورباش" property="og:title">
<meta content="من دو تا مودم اینترنت دارم. ADSL و TD-LTE. در این پست میخام بگم برای اینکه بتونم همزمان از هردوشون برای اتصال به اینترنت استفاده کنم چه کاری انجام دادم.
نسخه کوتاه: با استفاده از iptables و route در لینوکس
اولین کاری که کردم روی کامپیوتر خونه Ubuntu 20.10 نصب کردم. و وارد پنل کانفیگ یکی از مودم ها شدم و آدرس شبکه اش رو از 192.168.1.1 به 192.168.48.1 تغییر دادم تا با هم تداخل پیدا نکنند." property="og:description">
<meta property="og:url" content="https://doorbash.github.io/blog/posts/%D8%A7%D8%B3%D8%AA%D9%81%D8%A7%D8%AF%D9%87_%D9%87%D9%85%D8%B2%D9%85%D8%A7%D9%86_%D8%A7%D8%B2_%D8%AF%D9%88_%D9%85%D9%88%D8%AF%D9%85_%D8%A7%DB%8C%D9%86%D8%AA%D8%B1%D9%86%D8%AA/" />
<meta property="og:site_name" content="بلاگ - میلاد دورباش" />

<meta property="article:published_time" content="2021-03-27 00:00:00 &#43;0000 UTC" />





<script type="application/ld+json">
{ 
    "@context": "http://schema.org", 
    "@type": "BlogPosting",
    "headline": "استفاده همزمان از دو مودم اینترنت",
    "genre": "",  
    "url": "https:\/\/doorbash.github.io\/blog\/posts\/%D8%A7%D8%B3%D8%AA%D9%81%D8%A7%D8%AF%D9%87_%D9%87%D9%85%D8%B2%D9%85%D8%A7%D9%86_%D8%A7%D8%B2_%D8%AF%D9%88_%D9%85%D9%88%D8%AF%D9%85_%D8%A7%DB%8C%D9%86%D8%AA%D8%B1%D9%86%D8%AA\/",
    "datePublished": "2021-03-27 00:00:00 \u002b0000 UTC",
    "description": "من دو تا مودم اینترنت دارم. ADSL و TD-LTE. در این پست میخام بگم برای اینکه بتونم همزمان از هردوشون برای اتصال به اینترنت استفاده کنم چه کاری انجام دادم.\nنسخه کوتاه: با استفاده از iptables و route در لینوکس\nاولین کاری که کردم روی کامپیوتر خونه Ubuntu 20.10 نصب کردم. و وارد پنل کانفیگ یکی از مودم ها شدم و آدرس شبکه اش رو از 192.168.1.1 به 192.168.48.1 تغییر دادم تا با هم تداخل پیدا نکنند.",
    "author": {
        "@type": "Person",
        "name": ""
    }
 }
</script>




<link rel="stylesheet" href="/blog/sass/main.css">
<link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css">
</head>


  <body>

    <header class="site-header">
<nav class="navbar navbar-default">
  <div class="container-fluid">
    
    <div class="navbar-header">
      <a class="navbar-brand" href="https://doorbash.github.io/blog/">بلاگ - میلاد دورباش</a>
    </div>
  </div>
</nav>
</header>


    <div class="container">
      <div class="wrapper">
        
<div class="row">

<div class="col-md-4 mt20">
        <div class="post-img">
           
            <img width="600" src="https://doorbash.github.io/blog/images/loadbalance.png" alt="استفاده همزمان از دو مودم اینترنت">
            
        </div>
            
        
        <div class="mt10 recent">
            <h3 class="mb16">نوشته‌های اخیر</h3>        
             <ul>
                

                      <li>
                      <p><small>May 21, 2021&nbsp;&nbsp;</small><a href="https://doorbash.github.io/blog/posts/%D9%BE%D8%B1%D9%88%DA%98%D9%87_%D8%AC%D8%AF%DB%8C%D8%AF_%D8%A8%D8%A7%D8%B2%DB%8C_solitaire_klondike/">پروژه جدید: بازی Solitaire Klondike</a></p>
                      </li>

                

                      <li>
                      <p><small>March 27, 2021&nbsp;&nbsp;</small><a href="https://doorbash.github.io/blog/posts/%D8%A7%D8%B3%D8%AA%D9%81%D8%A7%D8%AF%D9%87_%D9%87%D9%85%D8%B2%D9%85%D8%A7%D9%86_%D8%A7%D8%B2_%D8%AF%D9%88_%D9%85%D9%88%D8%AF%D9%85_%D8%A7%DB%8C%D9%86%D8%AA%D8%B1%D9%86%D8%AA/">استفاده همزمان از دو مودم اینترنت</a></p>
                      </li>

                

                      <li>
                      <p><small>October 9, 2020&nbsp;&nbsp;</small><a href="https://doorbash.github.io/blog/posts/%D9%85%DB%8C%D8%B2%D8%A8%D8%A7%D9%86%DB%8C_%D8%B3%D8%B1%D9%88%D8%B1_%DA%AF%DB%8C%D8%AA_%D8%B4%D8%AE%D8%B5%DB%8C/">میزبانی سرور گیت شخصی</a></p>
                      </li>

                
              </ul>
        </div>
        
        <br>

</div>

<div class="col-md-8">
    <article class="post" itemscope itemtype="http://schema.org/BlogPosting">

          <header class="post-header">
            <h1 class="post-title" itemprop="name headline">استفاده همزمان از دو مودم اینترنت</h1>
            <p class="post-meta"><time datetime='2021-03-27T00:00:00Z' itemprop="datePublished">March 27, 2021</time></p>
                 
          </header>

          <div class="post-content" itemprop="articleBody">
            <p>من دو تا مودم اینترنت دارم. ADSL و TD-LTE. در این پست میخام بگم برای اینکه بتونم همزمان از هردوشون برای اتصال به اینترنت استفاده کنم چه کاری انجام دادم.</p>
<p><strong>نسخه کوتاه:</strong> با استفاده از iptables و route در لینوکس</p>
<p>اولین کاری که کردم روی کامپیوتر خونه Ubuntu 20.10 نصب کردم. و وارد پنل کانفیگ یکی از مودم ها شدم و آدرس شبکه اش رو از 192.168.1.1 به 192.168.48.1 تغییر دادم تا با هم تداخل پیدا نکنند.یکی از مودم ها با کابل شبکه به کامپیوتر متصله با آدرس 192.168.48.160 و اون یکی توسط وای فای به آدرس ثابت 192.168.1.160.</p>
<p>در واقع اساس کاری که انجام میدیم اینه که میایم پکت ها رو حالا یا نوبتی یا به صورت تصادفی مارک میکنیم (شماره گذاری میکنیم) و rule هایی برای route تعریف میکنیم که بر اساس این مارک ها به پکت ها مسیر بده. مثلا براش تعریف میکنیم که پکت هایی که مارک 1 دارند توسط وای فای ارسال بشوند و پکت هایی که مارک 2 دارند توسط کابل.</p>
<p>و در آخر کاری میکنیم که وقتی دستگاه ها به هر کدوم از مودم ها وصل شدند بجای مودم از کامپیوتر IP بگیرند. اینطوری میتونیم آدرس IP کامپیوتر رو بجای آدرس مودم به عنوان gateway IP بدیم. تا پکت ها رو به جای مودم برای ما بفرستند.</p>
<p><strong>مرحله اول: مارک کردن پکت ها</strong></p>
<p>اولین کاری که میکنیم تمام chain ها و rule های iptables رو پاک میکنیم:</p>
<div class="highlight"><pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-Bash" data-lang="Bash">iptables -F
iptables -t mangle -F
iptables -t mangle -X
iptables -t nat -F
iptables -t nat -X
</code></pre></div><p>بعدش میایم در جدول mangle (که عموما برای دستکاری پکت ها استفاده میشه) و در زنجیره PREROUTING (این زنجیره برای هر پکتی که میاد صدا زده میشه) میگیم</p>
<p>اگر پکت tcp نیست: (مثل udp و icmp و &hellip;)</p>
<div class="highlight"><pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-plaintext" data-lang="plaintext">! -p tcp
</code></pre></div><p>و آدرس منبعش از داخل شبکه هست:</p>
<div class="highlight"><pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-plaintext" data-lang="plaintext">-s 192.168.0.0/16
</code></pre></div><p>و آدرس مقصدش بیرون شبکه است:</p>
<div class="highlight"><pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-plaintext" data-lang="plaintext">! -d 192.168.0.0/16
</code></pre></div><p>با احتمال 50 درصد:</p>
<div class="highlight"><pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-plaintext" data-lang="plaintext">-m statistic --mode random --probability 0.5
</code></pre></div><p>مارک 1 بهش بده:</p>
<div class="highlight"><pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-plaintext" data-lang="plaintext">-j MARK --set-mark 1
</code></pre></div><p>که جمعا میشه این خط:</p>
<div class="highlight"><pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-plaintext" data-lang="plaintext">iptables -t mangle -A PREROUTING ! -p tcp -s 192.168.0.0/16 ! -d 192.168.0.0/16 -m statistic --mode random --probability 0.5 -j MARK --set-mark 1
</code></pre></div><p>تو خط بعد میگیم اگر پکت مارک نداشت (یعنی تو دستور قبلی مارک نگرفته بود) یا به عبارت دیگه مارکش 0x0 بود:</p>
<div class="highlight"><pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-plaintext" data-lang="plaintext">-m mark --mark 0x0
</code></pre></div><p>بهش مارک 2 بده:</p>
<div class="highlight"><pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-plaintext" data-lang="plaintext">iptables -t mangle -A PREROUTING ! -p tcp -s 192.168.0.0/16 ! -d 192.168.0.0/16 -m mark --mark 0x0 -j MARK --set-mark 2
</code></pre></div><p>پروتکل tcp رو جدا کردیم چون مارک کردن پکت های tcp به همین سادگی نیست که هر کدوم رو خواستیم هر طرفی بفرستیم. دلیلشم اینه که پروتکل tcp مبتنی بر کانکشن هست و پکت هایی که مرتبط با هر کانکشن هستند باید حتما همگی از یک IP ارسال بشن. یا به عبارت دیگه پکت شروع هر مارکی گرفت بقیه پکت های اون کانکشن هم باید همون مارک رو بگیرند.</p>
<p>پس این بار برای tcp میگیم:</p>
<p>اگر پکت برای شروع کانکشن جدید بود:</p>
<div class="highlight"><pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-plaintext" data-lang="plaintext">-m conntrack --ctstate NEW 
</code></pre></div><p>با احتمال 50 درصد براش زنجیره CONNMARK1 را اجرا کن:</p>
<div class="highlight"><pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-plaintext" data-lang="plaintext">-m statistic --mode random --probability 0.5 -j CONNMARK1
</code></pre></div><p>(این زنجیره رو بعدا قراره خودمون تعریف کنیم)</p>
<p>که کلا میشه این دستور:</p>
<div class="highlight"><pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-plaintext" data-lang="plaintext">iptables -t mangle -A PREROUTING -p tcp -s 192.168.0.0/16 ! -d 192.168.0.0/16 -m conntrack --ctstate NEW -m statistic --mode random --probability 0.5 -j CONNMARK1
</code></pre></div><p>و اگر تو دستور قبلی مارک نگرفته بود زنجیره CONNMARK2 رو براش اجرا کن:</p>
<div class="highlight"><pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-plaintext" data-lang="plaintext">iptables -t mangle -A PREROUTING -p tcp -s 192.168.0.0/16 ! -d 192.168.0.0/16 -m conntrack --ctstate NEW -m mark --mark 0x0 -j CONNMARK2
</code></pre></div><p>حالا زنجیره CONNMARK1 رو تعریف میکنیم:</p>
<div class="highlight"><pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-plaintext" data-lang="plaintext">iptables -t mangle -N CONNMARK1
</code></pre></div><p>و میگیم وقتی این زنجیره اجرا شد پکت رو مارک 1 کن:</p>
<div class="highlight"><pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-plaintext" data-lang="plaintext">iptables -t mangle -A CONNMARK1 -j MARK --set-mark 1
</code></pre></div><p>و بعدش میگیم مارک این پکت رو برای این کانکشن سیو کن:</p>
<div class="highlight"><pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-plaintext" data-lang="plaintext">iptables -t mangle -A CONNMARK1 -j CONNMARK --save-mark
</code></pre></div><p>همین کار هارو برای زنجیره CONNMARK2 هم انجام میدیم:</p>
<div class="highlight"><pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-plaintext" data-lang="plaintext">iptables -t mangle -N CONNMARK2
iptables -t mangle -A CONNMARK2 -j MARK --set-mark 2
iptables -t mangle -A CONNMARK2 -j CONNMARK --save-mark
</code></pre></div><p>خب تا اینجا هر پکتی که شروع کانکشن جدید بود مارک میخوره و مارکش تو کانکشن ها ذخیره میشه.</p>
<p>حالا میگیم اگر پکت شروع کانکشن جدید نیست:</p>
<div class="highlight"><pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-plaintext" data-lang="plaintext">-m conntrack --ctstate ESTABLISHED,RELATED 
</code></pre></div><p>برو ببین مارکش از کانکشن ها چیه روش مارک بزن:</p>
<div class="highlight"><pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-plaintext" data-lang="plaintext">-j CONNMARK --restore-mark
</code></pre></div><p>که کلا میشه این دستور:</p>
<div class="highlight"><pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-Bash" data-lang="Bash">iptables -t mangle -A PREROUTING -p tcp -s 192.168.0.0/16 ! -d 192.168.0.0/16 -m conntrack --ctstate ESTABLISHED,RELATED -j CONNMARK --restore-mark
</code></pre></div><p>تا اینجا تقریبا تمومه . ولی یه نکته ای مونده. اونم اینکه پکت ها الان با آدرس منبع خودشون دارن از طرف ما برای مودم ها ارسال میشن و ما این رو نمیخایم. ما میخایم پکت از آدرس IP ما برای مودم فرستاده بشه تا جوابش هم دوباره برای خودمون بیاد (در غیر این صورت اگه دستگاه مستقیم به مودم وصل نباشه جوابش به دستش نمیرسه) برای همین میایم از این دستور استفاده میکنیم:</p>
<div class="highlight"><pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-plaintext" data-lang="plaintext">iptables -t nat -A POSTROUTING -o wlp7s0 -j MASQUERADE
iptables -t nat -A POSTROUTING -o enp8s0 -j MASQUERADE
</code></pre></div><p>بعد از o- اسم اینترفیس خروجی میاد که من مال خودمو نوشتم.</p>
<p>تا الان دستوراتمون اینطوری شد:</p>
<div class="highlight"><pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-plaintext" data-lang="plaintext">iptables -F
iptables -t mangle -F
iptables -t mangle -X
iptables -t nat -F
iptables -t nat -X

iptables -t mangle -A PREROUTING ! -p tcp -s 192.168.0.0/16 ! -d 192.168.0.0/16 -m statistic --mode random --probability 0.5 -j MARK --set-mark 1
iptables -t mangle -A PREROUTING ! -p tcp -s 192.168.0.0/16 ! -d 192.168.0.0/16 -m mark --mark 0x0 -j MARK --set-mark 2

iptables -t mangle -N CONNMARK1
iptables -t mangle -A CONNMARK1 -j MARK --set-mark 1
iptables -t mangle -A CONNMARK1 -j CONNMARK --save-mark

iptables -t mangle -N CONNMARK2
iptables -t mangle -A CONNMARK2 -j MARK --set-mark 2
iptables -t mangle -A CONNMARK2 -j CONNMARK --save-mark

iptables -t mangle -A PREROUTING -p tcp -s 192.168.0.0/16 ! -d 192.168.0.0/16 -m conntrack --ctstate ESTABLISHED,RELATED -j CONNMARK --restore-mark
iptables -t mangle -A PREROUTING -p tcp -s 192.168.0.0/16 ! -d 192.168.0.0/16 -m conntrack --ctstate NEW -m statistic --mode random --probability 0.5 -j CONNMARK1
iptables -t mangle -A PREROUTING -p tcp -s 192.168.0.0/16 ! -d 192.168.0.0/16 -m conntrack --ctstate NEW -m mark --mark 0x0 -j CONNMARK2

iptables -t nat -A POSTROUTING -o wlp7s0 -j MASQUERADE
iptables -t nat -A POSTROUTING -o enp8s0 -j MASQUERADE
</code></pre></div><p><strong>مرحله دوم: مسیردادن به پکت ها</strong></p>
<p>کاری که میکنیم اینه که داخل این فایل:</p>
<div class="highlight"><pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-plaintext" data-lang="plaintext">/etc/iproute2/rt_tables
</code></pre></div><p>دو جدول جدید اضافه میکنیم:</p>
<div class="highlight"><pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-plaintext" data-lang="plaintext">251     rt_link1
252     rt_link2
</code></pre></div><p>بعدش با دو دستور زیر میگیم برای مارک 1 از جدول rt_link1 مسیریابی کن و برای 2 هم rt_link2:</p>
<div class="highlight"><pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-plaintext" data-lang="plaintext">ip rule add fwmark 1 table rt_link1
ip rule add fwmark 2 table rt_link2
</code></pre></div><p>حالا مسیرهای داخل جدول 1 و 2 رو تعریف میکنیم:</p>
<div class="highlight"><pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-plaintext" data-lang="plaintext">ip route add table rt_link1 default via 192.168.48.1 dev wlp7s0
ip route add table rt_link2 default via 192.168.1.1 dev enp8s0
</code></pre></div><p>و cache  رو پاک میکنیم:</p>
<div class="highlight"><pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-plaintext" data-lang="plaintext">ip route flush cache
</code></pre></div><p>و در آخر ip forwarding رو فعال میکنیم و rp filter رو غیر فعال:</p>
<div class="highlight"><pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-plaintext" data-lang="plaintext">echo 1 &gt; /proc/sys/net/ipv4/ip_forward
echo 0 &gt; /proc/sys/net/ipv4/conf/all/rp_filter
</code></pre></div><p><strong>مرحله سوم: نصب سرور DHCP</strong></p>
<p>تقریبا تمومه. کاری که مونده اینه که سرور dhcp نصب کنیم تا دستگاه هایی که به مودم وصل میشن IP بگیرن:</p>
<div class="highlight"><pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-plaintext" data-lang="plaintext">sudo apt-get install isc-dhcp-server -y
</code></pre></div><p>فایل کانفیگش رو باز میکنیم:</p>
<div class="highlight"><pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-plaintext" data-lang="plaintext">sudo gedit /etc/dhcp/dhcpd.conf
</code></pre></div><p>و تغییرات زیر رو اعمال میکنیم:</p>
<div class="highlight"><pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-plaintext" data-lang="plaintext">option domain-name &#34;&#34;;
option domain-name-servers 8.8.8.8, 1.1.1.1;

default-lease-time 600;
max-lease-time 7200;

ddns-update-style none;

authoritative;

subnet 192.168.1.0 netmask 255.255.255.0 {
  # Specify the default gateway address
  option routers 192.168.1.160;
  # Specify the subnet-mask
  option subnet-mask 255.255.255.0;
  # Specify the range of leased IP addresses
  range 192.168.1.2 192.168.1.50;
}
subnet 192.168.48.0 netmask 255.255.255.0 {
  # Specify the default gateway address
  option routers 192.168.48.160;
  # Specify the subnet-mask
  option subnet-mask 255.255.255.0;
  # Specify the range of leased IP addresses
  range 192.168.48.2 192.168.48.50;
}
</code></pre></div><p>و ریستارتش میکنیم:</p>
<div class="highlight"><pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-plaintext" data-lang="plaintext">sudo systemctl restart isc-dhcp-server.service
</code></pre></div><p><strong>مرحله چهارم: استارتاپ</strong></p>
<p>مرحله آخر اینه که کاری کنیم وقتی لینوکس بالا اومد دستوراتی که نوشتیم اجرا بشه. اینجا خوب توضیح داده چکار باید کرد:
<p class="_ltr"><a href="https://linuxconfig.org/how-to-run-script-on-startup-on-ubuntu-20-04-focal-fossa-server-desktop" target="_blank">https://linuxconfig.org/how-to-run-script-on-startup-on-ubuntu-20-04-focal-fossa-server-desktop</a></p></p>
<p><strong>کد کامل:</strong></p>
<div class="highlight"><pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-Bash" data-lang="Bash"><span style="color:#999;font-weight:bold;font-style:italic">#!/bin/bash
</span><span style="color:#999;font-weight:bold;font-style:italic"></span>
<span style="color:#0086b3">echo</span> <span style="color:#099">1</span> &gt;| /proc/sys/net/ipv4/ip_forward
<span style="color:#0086b3">echo</span> <span style="color:#099">0</span> &gt;| /proc/sys/net/ipv4/conf/all/rp_filter

iptables -F
iptables -t mangle -F
iptables -t mangle -X
iptables -t nat -F
iptables -t nat -X

iptables -t mangle -N CONNMARK1
iptables -t mangle -A CONNMARK1 -j MARK --set-mark <span style="color:#099">1</span>
iptables -t mangle -A CONNMARK1 -j CONNMARK --save-mark

iptables -t mangle -N CONNMARK2
iptables -t mangle -A CONNMARK2 -j MARK --set-mark <span style="color:#099">2</span>
iptables -t mangle -A CONNMARK2 -j CONNMARK --save-mark

iptables -t mangle -A PREROUTING -p tcp -s 192.168.0.0/16 ! -d 192.168.0.0/16 -m conntrack --ctstate ESTABLISHED,RELATED -j CONNMARK --restore-mark
iptables -t mangle -A PREROUTING -p tcp -s 192.168.0.0/16 ! -d 192.168.0.0/16 -m conntrack --ctstate NEW -m statistic --mode random --probability 0.5 -j CONNMARK1
iptables -t mangle -A PREROUTING -p tcp -s 192.168.0.0/16 ! -d 192.168.0.0/16 -m conntrack --ctstate NEW -m mark --mark 0x0 -j CONNMARK2

iptables -t mangle -A PREROUTING ! -p tcp -s 192.168.0.0/16 ! -d 192.168.0.0/16 -m statistic --mode random --probability 0.5 -j MARK --set-mark <span style="color:#099">1</span>
iptables -t mangle -A PREROUTING ! -p tcp -s 192.168.0.0/16 ! -d 192.168.0.0/16 -m mark --mark 0x0 -j MARK --set-mark <span style="color:#099">2</span>

iptables -t nat -A POSTROUTING -o wlp7s0 -j MASQUERADE
iptables -t nat -A POSTROUTING -o enp8s0 -j MASQUERADE

<span style="color:#000;font-weight:bold">if</span> ! cat /etc/iproute2/rt_tables | grep -q <span style="color:#d14">&#39;^251&#39;</span>
<span style="color:#000;font-weight:bold">then</span>
    <span style="color:#0086b3">echo</span> <span style="color:#d14">&#39;251     rt_link1&#39;</span> &gt;&gt; /etc/iproute2/rt_tables
<span style="color:#000;font-weight:bold">fi</span>
<span style="color:#000;font-weight:bold">if</span> ! cat /etc/iproute2/rt_tables | grep -q <span style="color:#d14">&#39;^252&#39;</span>
<span style="color:#000;font-weight:bold">then</span>
    <span style="color:#0086b3">echo</span> <span style="color:#d14">&#39;252     rt_link2&#39;</span> &gt;&gt; /etc/iproute2/rt_tables
<span style="color:#000;font-weight:bold">fi</span>

ip route flush table rt_link1 2&gt;/dev/null
ip route add table rt_link1 default via 192.168.48.1 dev wlp7s0

ip route flush table rt_link2 2&gt;/dev/null
ip route add table rt_link2 default via 192.168.1.1 dev enp8s0

ip rule del from all fwmark 0x1 lookup rt_link1 2&gt;/dev/null
ip rule del from all fwmark 0x2 lookup rt_link2 2&gt;/dev/null
ip rule del from all fwmark 0x2 2&gt;/dev/null
ip rule del from all fwmark 0x1 2&gt;/dev/null
ip rule add fwmark <span style="color:#099">1</span> table rt_link1
ip rule add fwmark <span style="color:#099">2</span> table rt_link2

ip route flush cache
</code></pre></div><p>لینک کد در گیتهاب:
<p class="_ltr"><a href="https://gist.github.com/doorbash/a88a28e34e189b2b771b303691264ea6" target="_blank">https://gist.github.com/doorbash/a88a28e34e189b2b771b303691264ea6</a></p></p>
<p>در آخر توصیه میکنم حتما این لینک رو بخونید خیلی خوب توضیح داده:</p>
<p class="_ltr"><a href="https://www.system-rescue.org/networking/Load-balancing-using-iptables-with-connmark/" target="_blank">https://www.system-rescue.org/networking/Load-balancing-using-iptables-with-connmark/</a></p>
<p><strong>پی نوشت (30/3/2021):</strong></p>
<p>میتونیم پکت های غیر TCP رو بجای اینکه تصادفی برای گیت‌وی ها بفرستیم برای هردوشون بفرستیم:</p>
<div class="highlight"><pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-plaintext" data-lang="plaintext">iptables -t mangle -N NOTTCP1
iptables -t mangle -A NOTTCP1 -j MARK --set-mark 1
iptables -t mangle -A NOTTCP1 -j TEE --gateway 192.168.1.1

iptables -t mangle -N NOTTCP2
iptables -t mangle -A NOTTCP2 -j MARK --set-mark 2
iptables -t mangle -A NOTTCP2 -j TEE --gateway 192.168.48.1

iptables -t mangle -A PREROUTING ! -p tcp -s 192.168.1.0/24 ! -d 192.168.0.0/16 -j NOTTCP1
iptables -t mangle -A PREROUTING ! -p tcp -s 192.168.48.0/24 ! -d 192.168.0.0/16 -j NOTTCP2
</code></pre></div><p>با این کار خود پکت میره برای گیت‌وی شبکه دیگه (مثلا اگه از شبکه 192.168.1.0/24 اومده میره برای 192.168.48.1) و نت میشه و یک کپی ازش میره برای گیت‌وی شبکه ای که ازش اومده (تو این حالت نت نمیشه). تو حالت اول جواب پکت از طرف ما میره براش و تو حالت دوم جوابش از طرف مودمی که بهش وصله براش ارسال میشه.</p>

          </div>

    </article>
    <div class="row">
        
         
<div id="disqus_thread"></div>
<script defer>
(function() {
    var d = document, s = d.createElement('script');
    s.src = '//doorbash-github-io.disqus.com/embed.js';
    s.setAttribute('data-timestamp', +new Date());
    (d.head || d.body).appendChild(s);
})();
</script>
<noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>

        
    </div>
</div>

</div>




      </div>
    </div>

    <footer>
    <div class="container">
        <div class="row p20">
            
                <div class="col-md-4 text-center mt25">All rights reserved by <a target="_blank" href="https://doorbash.github.io">میلاد دورباش</a></div>
            

            <div class="col-md-4 text-center mt25" >
                
                <a target="_blank" href="https://bool.netlify.com"><img src="https://img.shields.io/badge/Built%20by-bool-brightgreen.svg" alt="bool"></a>
                
            </div>
            <div class="col-md-4 text-center mt25">
               
                <a target="_blank" href="https://github.com/doorbash"><li class="social github"><i class="fa fa-github-square"></i></li></a>
                
               
                <a target="_blank" href="mailto:milad.doorbash@gmail.com"><li class="social email"><i class="fa fa-envelope"></i></li></a>
                
            </div>

        </div> 
    </div>
</footer>
    

  <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.12.2/jquery.min.js"></script>
  <script src="https://doorbash.github.io/blog//js/bootstrap.min.js"></script>
   
     
<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-128176167-2', 'auto');
  ga('send', 'pageview');
</script>
  
  </body>

</html>