<!DOCTYPE html>
<html>

  <head>
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1">

<title>پروژه جدید: بازی Solitaire Klondike - بلاگ - میلاد دورباش</title>
<meta name="description" content="این بازی (Solitaire) یک بازی اندرویدی یک نفره با ورق (پاسور) هست که فعلا ویژگی های زیر رو داره:
 حالت سه کارتی و تک کارتی حرکت با لمس کارت نمایش امتیاز و زمان دکمه آندو (برگرداندن) چینش دست چپی امکان تعیین جهت صفحه (افقی، عمودی یا چرخش خودکار) دو نوع چینش حالت افقی نمایش آمار بازی و لیست بازی های قبلی پشتیبانی از دو زبان فارسی و انگلیسی امکان قطع و وصل کردن صدای بازی  فریمورک ها و کتابخانه ها بازی با استفاده از LibGDX  ساخته شده و با زبان برنامه نویسی کاتلین  (و کمی هم جاوا)"/>
<meta name="robots" content="noodp"/>
<link rel="canonical" href="https://doorbash.github.io/blog/posts/%D9%BE%D8%B1%D9%88%DA%98%D9%87_%D8%AC%D8%AF%DB%8C%D8%AF_%D8%A8%D8%A7%D8%B2%DB%8C_solitaire_klondike/" />


<meta name="twitter:card" content="summary" />
<meta name="twitter:description" content="این بازی (Solitaire) یک بازی اندرویدی یک نفره با ورق (پاسور) هست که فعلا ویژگی های زیر رو داره:
 حالت سه کارتی و تک کارتی حرکت با لمس کارت نمایش امتیاز و زمان دکمه آندو (برگرداندن) چینش دست چپی امکان تعیین جهت صفحه (افقی، عمودی یا چرخش خودکار) دو نوع چینش حالت افقی نمایش آمار بازی و لیست بازی های قبلی پشتیبانی از دو زبان فارسی و انگلیسی امکان قطع و وصل کردن صدای بازی  فریمورک ها و کتابخانه ها بازی با استفاده از LibGDX  ساخته شده و با زبان برنامه نویسی کاتلین  (و کمی هم جاوا)" />
<meta name="twitter:title" content="پروژه جدید: بازی Solitaire Klondike - بلاگ - میلاد دورباش" />
<meta name="twitter:site" content="http://twitter.com/bul_ikana" />
<meta name="twitter:creator" content="http://twitter.com/bul_ikana" />


<meta property="og:type" content="article" />
<meta content="پروژه جدید: بازی Solitaire Klondike - بلاگ - میلاد دورباش" property="og:title">
<meta content="این بازی (Solitaire) یک بازی اندرویدی یک نفره با ورق (پاسور) هست که فعلا ویژگی های زیر رو داره:
 حالت سه کارتی و تک کارتی حرکت با لمس کارت نمایش امتیاز و زمان دکمه آندو (برگرداندن) چینش دست چپی امکان تعیین جهت صفحه (افقی، عمودی یا چرخش خودکار) دو نوع چینش حالت افقی نمایش آمار بازی و لیست بازی های قبلی پشتیبانی از دو زبان فارسی و انگلیسی امکان قطع و وصل کردن صدای بازی  فریمورک ها و کتابخانه ها بازی با استفاده از LibGDX  ساخته شده و با زبان برنامه نویسی کاتلین  (و کمی هم جاوا)" property="og:description">
<meta property="og:url" content="https://doorbash.github.io/blog/posts/%D9%BE%D8%B1%D9%88%DA%98%D9%87_%D8%AC%D8%AF%DB%8C%D8%AF_%D8%A8%D8%A7%D8%B2%DB%8C_solitaire_klondike/" />
<meta property="og:site_name" content="بلاگ - میلاد دورباش" />

<meta property="article:published_time" content="2021-05-22 00:00:00 &#43;0000 UTC" />





<script type="application/ld+json">
{ 
    "@context": "http://schema.org", 
    "@type": "BlogPosting",
    "headline": "پروژه جدید: بازی Solitaire Klondike",
    "genre": "",  
    "url": "https:\/\/doorbash.github.io\/blog\/posts\/%D9%BE%D8%B1%D9%88%DA%98%D9%87_%D8%AC%D8%AF%DB%8C%D8%AF_%D8%A8%D8%A7%D8%B2%DB%8C_solitaire_klondike\/",
    "datePublished": "2021-05-22 00:00:00 \u002b0000 UTC",
    "description": "این بازی (Solitaire) یک بازی اندرویدی یک نفره با ورق (پاسور) هست که فعلا ویژگی های زیر رو داره:\n حالت سه کارتی و تک کارتی حرکت با لمس کارت نمایش امتیاز و زمان دکمه آندو (برگرداندن) چینش دست چپی امکان تعیین جهت صفحه (افقی، عمودی یا چرخش خودکار) دو نوع چینش حالت افقی نمایش آمار بازی و لیست بازی های قبلی پشتیبانی از دو زبان فارسی و انگلیسی امکان قطع و وصل کردن صدای بازی  فریمورک ها و کتابخانه ها بازی با استفاده از LibGDX  ساخته شده و با زبان برنامه نویسی کاتلین  (و کمی هم جاوا)",
    "author": {
        "@type": "Person",
        "name": ""
    }
 }
</script>




<link rel="stylesheet" href="/blog/sass/main.css">
<link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css">
</head>


  <body>

    <header class="site-header">
<nav class="navbar navbar-default">
  <div class="container-fluid">
    
    <div class="navbar-header">
      <a class="navbar-brand" href="https://doorbash.github.io/blog/">بلاگ - میلاد دورباش</a>
    </div>
  </div>
</nav>
</header>


    <div class="container">
      <div class="wrapper">
        
<div class="row">

<div class="col-md-4 mt20">
        <div class="post-img">
           
            <img width="600" src="https://doorbash.github.io/blog/images/solitaire.jpg" alt="پروژه جدید: بازی Solitaire Klondike">
            
        </div>
            
        
        <div class="mt10 recent">
            <h3 class="mb16">نوشته‌های اخیر</h3>        
             <ul>
                

                      <li>
                      <p><small>May 22, 2021&nbsp;&nbsp;</small><a href="https://doorbash.github.io/blog/posts/%D9%BE%D8%B1%D9%88%DA%98%D9%87_%D8%AC%D8%AF%DB%8C%D8%AF_%D8%A8%D8%A7%D8%B2%DB%8C_solitaire_klondike/">پروژه جدید: بازی Solitaire Klondike</a></p>
                      </li>

                

                      <li>
                      <p><small>March 27, 2021&nbsp;&nbsp;</small><a href="https://doorbash.github.io/blog/posts/%D8%A7%D8%B3%D8%AA%D9%81%D8%A7%D8%AF%D9%87_%D9%87%D9%85%D8%B2%D9%85%D8%A7%D9%86_%D8%A7%D8%B2_%D8%AF%D9%88_%D9%85%D9%88%D8%AF%D9%85_%D8%A7%DB%8C%D9%86%D8%AA%D8%B1%D9%86%D8%AA/">استفاده همزمان از دو مودم اینترنت</a></p>
                      </li>

                

                      <li>
                      <p><small>October 9, 2020&nbsp;&nbsp;</small><a href="https://doorbash.github.io/blog/posts/%D9%85%DB%8C%D8%B2%D8%A8%D8%A7%D9%86%DB%8C_%D8%B3%D8%B1%D9%88%D8%B1_%DA%AF%DB%8C%D8%AA_%D8%B4%D8%AE%D8%B5%DB%8C/">میزبانی سرور گیت شخصی</a></p>
                      </li>

                
              </ul>
        </div>
        
        <br>

</div>

<div class="col-md-8">
    <article class="post" itemscope itemtype="http://schema.org/BlogPosting">

          <header class="post-header">
            <h1 class="post-title" itemprop="name headline">پروژه جدید: بازی Solitaire Klondike</h1>
            <p class="post-meta"><time datetime='2021-05-22T00:00:00Z' itemprop="datePublished">May 22, 2021</time></p>
                 
          </header>

          <div class="post-content" itemprop="articleBody">
            <p><a href="https://cafebazaar.ir/app/io.github.doorbash.solitaire" target="_blank"><img class="post-content-img" src="https://doorbash.github.io/blog/images/cafebazaar-badge.png" alt="Download from CafeBazaar"  width="202" height="60"  /></a>
<a href="https://myket.ir/app/io.github.doorbash.solitaire" target="_blank"><img class="post-content-img" src="https://doorbash.github.io/blog/images/myket-badge.png" alt="Download from Myket"  width="202" height="60"  /></a>
<a href="https://play.google.com/store/apps/details?id=io.github.doorbash.solitaire" target="_blank"><img class="post-content-img" src="https://doorbash.github.io/blog/images/google-play-badge.png" alt="Download from Google Play"  width="201" height="60"  /></a></p>
<p>این بازی (Solitaire) یک بازی اندرویدی یک نفره با ورق (پاسور) هست که فعلا ویژگی های زیر رو داره:</p>
<ul>
<li>حالت سه کارتی و تک کارتی</li>
<li>حرکت با لمس کارت</li>
<li>نمایش امتیاز و زمان</li>
<li>دکمه آندو (برگرداندن)</li>
<li>چینش دست چپی</li>
<li>امکان تعیین جهت صفحه (افقی، عمودی یا چرخش خودکار)</li>
<li>دو نوع چینش حالت افقی</li>
<li>نمایش آمار بازی و لیست بازی های قبلی</li>
<li>پشتیبانی از دو زبان فارسی و انگلیسی</li>
<li>امکان قطع و وصل کردن صدای بازی</li>
</ul>
<p><img class="post-content-img" src="https://doorbash.github.io/blog/images/solitaire_screenshot_1.jpg" alt="solitaire screenshot" />
<img class="post-content-img" src="https://doorbash.github.io/blog/images/solitaire_screenshot_2.jpg" alt="solitaire screenshot" /></p>
<h3 id="فریمورک-ها-و-کتابخانه-ها">فریمورک ها و کتابخانه ها</h3>
<p>بازی با استفاده از <a href="https://libgdx.com/" target="_blank"> LibGDX </a> ساخته شده و با زبان برنامه نویسی <a href="https://kotlinlang.org/" target="_blank"> کاتلین </a> (و کمی هم جاوا)</p>
<p>برای شروع ساخت پروژه از <a href="https://github.com/tommyettinger/gdx-liftoff" target="_blank"> gdx-liftoff </a></p>
<p>برای گیم پلی و منو ها از <a href="https://github.com/libgdx/libgdx/wiki/Scene2d" target="_blank"> Scene2D </a> که متعلق به LibGDX هست.</p>
<p>از <a href="https://github.com/libktx/ktx" target="_blank"> LibKTX </a> برای کار کردن راحت تر با LibGDX</p>
<p>برای پک کردن عکس ها و فونت ها از <a href="https://github.com/raeleus/skin-composer" target="_blank"> Skin Composer </a></p>
<p>برای ذخیره و بازیابی استیت بازی و همینطور بازیابی لیست بازی های آسان از <a href="https://github.com/protocolbuffers/protobuf" target="_blank"> protobuf </a></p>
<p>منوهای بازی (و دکمه ها و switch و spinner) هم ویجت کاستوم هستن که از  floatingGroup از کتابخونه <a href="https://github.com/kotcrab/vis-ui" target="_blank"> vis-ui </a> ارث بری میکنند. البته فقط دیالوگ منو، تنظیمات و خروج از بازی.
برای ساخت دیالوگ &ldquo;بازی های قبلی&rdquo; و &ldquo;شما برنده شدید&rdquo; از Dialog اندروید SDK استفاده شده.</p>
<p>تم کل برنامه هم Theme.MaterialComponents.NoActionBar هست.</p>
<p>از کتابخونه <a href="https://github.com/marlonlom/timeago" target="_blank"> timeago </a> برای نمایش تاریخ به صورت نسبی (مثلا دو ساعت پیش)</p>
<p>آیکون ها هم <a href="https://github.com/google/material-design-icons" target="_blank"> آیکون های متریال دیزاین </a> گوگل هستن</p>
<h3 id="بهرهوری-یا-performance">بهره‌وری یا performance</h3>
<h4 id="--فریم-در-ثانیه-fps">- فریم در ثانیه (fps)</h4>
<p>تمام تصاویر، آیکون ها و فونت هایی که تو بازی استفاده شده در قالب یک عکس 1024x1024 پک شده. که باعث میشه فقط یک تکسچر بایند بشه و تعداد draw call ها تو هر فریم میشه 1.</p>
<h4 id="--ذخیره-و-بازیابی-از-فایل">- ذخیره و بازیابی از فایل</h4>
<p>برای پیاده سازی ذخیره و بازیابی بازی اول میخاستم از JSON استفاده کنم ولی ازونجایی که JSON به صورت متنی هست بهتر بود از روشی که باینری ذخیره میکنه استفاده میکردم. برای همین <a href="https://github.com/protocolbuffers/protobuf" target="_blank"> protobuf </a> رو انتخاب کردم. کتابخونه دیگه ای که از لحاظ بهره وری <a href="https://github.com/lxohi/java-json-protobuf-flatbuffers-kryo-jvm-benchmark" target="_blank"> توی بنچمارک هایی که دیدم </a> به protobuf نزدیکه <a href="https://github.com/EsotericSoftware/kryo" target="_blank"> kryo </a> بود که اونم میتونست انتخاب خوبی باشه.</p>
<p>این مثلا نحوه ذخیره لیست بازی ها رو نشون میده:
هر بازی 56 بایت فضا میگیره (52 کارت به اضافه 4 بایت سربار که خود protobuf برای ذخیره ساختار اضافه میکنه)</p>
<div class="highlight"><pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-plaintext" data-lang="plaintext">message GamePB {
  bytes data = 1;
}

message GamesPB {
  repeated GamePB list = 1;
}
</code></pre></div><h4 id="--proguard">- proguard</h4>
<p>تفاوت حجم فایل باندل نهایی بدون proguard و با proguard برای این پروژه یچیزی حدود 15MB بود. 
غیر از اون میشه برای proguard قوانینی گذاشت که null check های اضافی کاتلین رو خودش خودکار حذف کنه که توی performance تاثیر داره.</p>
<div class="highlight"><pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-plaintext" data-lang="plaintext">-assumenosideeffects class kotlin.jvm.internal.Intrinsics {
  public static void checkExpressionValueIsNotNull(java.lang.Object, java.lang.String);
  public static void checkFieldIsNotNull(java.lang.Object, java.lang.String);
  public static void checkFieldIsNotNull(java.lang.Object, java.lang.String, java.lang.String);
  public static void checkNotNull(java.lang.Object);
  public static void checkNotNull(java.lang.Object, java.lang.String);
  public static void checkNotNullExpressionValue(java.lang.Object, java.lang.String);
  public static void checkNotNullParameter(java.lang.Object, java.lang.String);
  public static void checkParameterIsNotNull(java.lang.Object, java.lang.String);
  public static void checkReturnedValueIsNotNull(java.lang.Object, java.lang.String);
  public static void checkReturnedValueIsNotNull(java.lang.Object, java.lang.String, java.lang.String);
  public static void throwUninitializedPropertyAccessException(java.lang.String);
}
</code></pre></div><h3 id="حجم-فایل-نصبی">حجم فایل نصبی</h3>
<p>از اونجایی که حجم فایل  نهایی زیر 15MB میشه. میتونیم از قابلیت Instant Play گوگل پلی استفاده کنیم. اینطوری یک دکمه Try now کنار دکمه نصب نشون میده که کاربر میتونه سریع بازی رو بدون نصب ببینه و بعد اگر خواست نصب کنه. به همین دلیل پایین بودن حجم یک مزیت محسوب میشه.</p>
<p>با جدا کردن فایل .so هر معماری تو gradle و حذف فایل استایل libgdx و تعریف دستیشون تو کد و یه سری حذف های جزئی و proguard تونستم حجم فایل نهایی رو بیارم روی 750KB.</p>
<p>اما بعد که protobuf اضافه کردم شد 920KB. هنوز زیر یک مگابایت بود! تا اینکه مجبور شدم برای رابط کابری از کتابخونه material گوگل استفاده کنم که با فونت ها و 20,000 بازی آسان حجم نهایی 3.6MB شد.</p>
<p><img src="https://media.giphy.com/media/B2l0NnxK9KiVa0CXBh/giphy.gif" alt="not great not terrible"></p>
<h3 id="چالش-ها">چالش ها</h3>
<p><strong>ریزش کارت ها آخر بازی</strong>:
برای پیاده کردن این قسمت اول فکر کردم با پاک نکردن صفحه زمان draw میشه ولی باعث شد کارت ها جاهای اشتباهی ترسیم بشن و کلا عجیب غریب شد. که بعد فهمیدم بخاطر double buffering هست.</p>
<p>بعدش کاری که کردم یک فریم بافر به اندازه صفحه ساختم. و زمان draw روی اون کارت ها رو draw کردم بدون اینکه پاکشون کنم. و بعد خود فریم بافر رو draw کردم.</p>
<div class="highlight"><pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-kotlin" data-lang="kotlin"><span style="color:#000;font-weight:bold">val</span> width = Gdx.graphics.width
<span style="color:#000;font-weight:bold">val</span> height = Gdx.graphics.height
fbo = FrameBuffer(Pixmap.Format.RGBA8888, width, height, <span style="color:#000;font-weight:bold">false</span>)
matrix = Matrix4().apply {
    setToOrtho2D(<span style="color:#099">0f</span>, height.toFloat(), width.toFloat(), -height.toFloat())
}

<span style="color:#000;font-weight:bold">..</span>. 

<span style="color:#998;font-style:italic">//draw
</span><span style="color:#998;font-style:italic"></span>
fbo.use {
  <span style="color:#998;font-style:italic">// draw on fbo
</span><span style="color:#998;font-style:italic"></span>}

stage.batch.use(stage.camera.combined) {
    <span style="color:#998;font-style:italic">// draw fbo
</span><span style="color:#998;font-style:italic"></span>    <span style="color:#000;font-weight:bold">it</span>.draw(fbo.colorBufferTexture, <span style="color:#099">0f</span>, <span style="color:#099">0f</span>)
}
</code></pre></div><img class="post-content-img" src="https://doorbash.github.io/blog/images/solitaire_card_trail.jpg" alt="card trail" />

          </div>

    </article>
    <div class="row">
        
         
<div id="disqus_thread"></div>
<script defer>
(function() {
    var d = document, s = d.createElement('script');
    s.src = '//doorbash-github-io.disqus.com/embed.js';
    s.setAttribute('data-timestamp', +new Date());
    (d.head || d.body).appendChild(s);
})();
</script>
<noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>

        
    </div>
</div>

</div>




      </div>
    </div>

    <footer>
    <div class="container">
        <div class="row p20">
            
                <div class="col-md-4 text-center mt25">All rights reserved by <a target="_blank" href="https://doorbash.github.io">میلاد دورباش</a></div>
            

            <div class="col-md-4 text-center mt25" >
                
                <a target="_blank" href="https://bool.netlify.com"><img src="https://img.shields.io/badge/Built%20by-bool-brightgreen.svg" alt="bool"></a>
                
            </div>
            <div class="col-md-4 text-center mt25">
               
                <a target="_blank" href="https://github.com/doorbash"><li class="social github"><i class="fa fa-github-square"></i></li></a>
                
               
                <a target="_blank" href="mailto:milad.doorbash@gmail.com"><li class="social email"><i class="fa fa-envelope"></i></li></a>
                
            </div>

        </div> 
    </div>
</footer>
    

  <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.12.2/jquery.min.js"></script>
  <script src="https://doorbash.github.io/blog//js/bootstrap.min.js"></script>
   
     
<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-128176167-2', 'auto');
  ga('send', 'pageview');
</script>
  
  </body>

</html>